<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CinemaRatioTool</title>
    <style>
        :root {
            --bg-glass: rgba(18, 18, 18, 0.96);
            --accent: #007aff;
            --text: #ffffff;
            /* Safe area variables, default to 20px if not supported */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-right: env(safe-area-inset-right, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-left: env(safe-area-inset-left, 20px);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #container {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: url('background.jpg') center/cover no-repeat, 
                        url('https://images.unsplash.com/photo-1501594907352-04cda38ebc29?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            z-index: 1;
            transition: background-image 0.3s ease;
        }

        .overlay {
            position: absolute;
            border-width: 3px;
            border-style: solid;
            pointer-events: none;
            box-sizing: border-box;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* Make borders sharper */
            box-shadow: 0 0 0 1px rgba(0,0,0,0.5);
        }

        .label {
            position: absolute;
            top: 0; left: 5px;
            font-size: 11px;
            background: rgba(0,0,0,0.85);
            padding: 2px 6px;
            border-radius: 0 0 4px 4px;
            font-weight: 800;
            color: #fff;
            white-space: nowrap;
        }

        #menu-trigger {
            position: fixed;
            /* Use safe area variables to avoid being cut off by notch or rounded corners */
            top: max(20px, var(--safe-top));
            right: max(20px, var(--safe-right));
            width: 50px; height: 50px;
            background: var(--bg-glass);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            cursor: pointer;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            font-size: 24px;
        }

        #floating-panel {
            position: fixed;
            top: calc(max(20px, var(--safe-top)) + 65px);
            right: max(20px, var(--safe-right));
            width: 360px;
            max-height: 80vh;
            background: var(--bg-glass);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            color: var(--text);
            padding: 24px;
            box-sizing: border-box;
            z-index: 1900;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            overflow-y: auto;
            opacity: 0;
            transform: translateY(-15px) scale(0.96);
            pointer-events: none;
            transition: all 0.25s ease-out;
        }

        #floating-panel.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        
        .btn-primary { 
            flex: 1; background: var(--accent); border: none; color: white; 
            border-radius: 12px; font-weight: bold; cursor: pointer; 
            font-size: 15px; padding: 14px; 
        }

        .btn-icon { 
            width: 48px; display: flex; justify-content: center; align-items: center; 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); 
            color: white; border-radius: 12px; cursor: pointer; font-size: 20px; 
        }
        
        #file-upload { display: none; }

        .ratio-list { display: grid; grid-template-columns: 1fr; gap: 4px; }
        
        .item { 
            display: flex; align-items: center; padding: 8px 12px; 
            border-radius: 10px; cursor: pointer; font-size: 15.5px; 
            transition: background 0.2s;
        }
        .item:hover { background: rgba(255,255,255,0.1); }
        .item input { width: 18px; height: 18px; margin-right: 14px; cursor: pointer; }

        .color-dash { font-weight: 900; margin-right: 10px; font-size: 18px; }

        #info-tag {
            position: fixed;
            /* Use safe area variables */
            bottom: max(20px, var(--safe-bottom));
            left: max(20px, var(--safe-left));
            font-size: 11px; color: rgba(255,255,255,0.7);
            background: rgba(0,0,0,0.7); padding: 10px 16px;
            border-radius: 15px; z-index: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: none;
            white-space: pre-wrap; /* Allow line wrapping */
            line-height: 1.5;
        }
        #info-tag strong { color: var(--accent); }
    </style>
</head>
<body>

    <div id="overlay-mask" style="position:fixed; inset:0; z-index:1800; display:none;" onclick="togglePanel()"></div>
    <div id="info-tag">Initializing...</div>
    <div id="menu-trigger" onclick="togglePanel()">‚öôÔ∏è</div>

    <div id="floating-panel">
        <div class="button-group">
            <button class="btn-primary" onclick="toggleFullScreen()">Toggle Fullscreen</button>
            <input type="file" id="file-upload" accept="image/*">
            <label for="file-upload" class="btn-icon" title="Upload Image">üìÅ</label>
        </div>
        <div class="ratio-list" id="ratio-list"></div>
    </div>

    <div id="container"></div>

    <script>
        // --- Configuration & State ---
        const configs = [
            { name: '1.00:1 (Square)', ratio: 1, class: 'c11', color: '#ffffff', active: false },
            { name: '1.33:1 = 4:3 (Traditional)', ratio: 4/3, class: 'c43', color: '#007aff', active: false },
            { name: '1.43:1 (IMAX GT)', ratio: 1.43, class: 'c143', color: '#ffd700', active: true },
            { name: '1.60:1 = 16:10 (Monitor)', ratio: 1.6, class: 'c1610', color: '#aaaaaa', active: false },
            { name: '1.78:1 = 16:9 (HDTV)', ratio: 16/9, class: 'c169', color: '#ff3b30', active: true },
            { name: '1.85:1 (Cinema Flat)', ratio: 1.85, class: 'c185', color: '#34c759', active: false },
            { name: '1.90:1 (Digital IMAX)', ratio: 1.9, class: 'c190', color: '#00ffff', active: true },
            { name: '2.00:1 (Univisium)', ratio: 2, class: 'c21', color: '#af52de', active: false },
            { name: '2.35:1 (Classic Scope)', ratio: 2.35, class: 'c235', color: '#ffcc00', active: false },
            { name: '2.39:1 (Modern Scope)', ratio: 2.39, class: 'c239', color: '#ff9500', active: true }
        ];

        // --- DOM Cache ---
        const elements = {
            container: document.getElementById('container'),
            ratioList: document.getElementById('ratio-list'),
            infoTag: document.getElementById('info-tag'),
            panel: document.getElementById('floating-panel'),
            mask: document.getElementById('overlay-mask'),
            fileInput: document.getElementById('file-upload'),
            trigger: document.getElementById('menu-trigger')
        };

        // --- Initialization ---
        function init() {
            configs.forEach((cfg, i) => {
                createOverlay(cfg, i);
                createMenuItem(cfg, i);
            });
            setupEventListeners();
            updateLayout();
        }

        function createOverlay(cfg, i) {
            const box = document.createElement('div');
            box.id = `box-${i}`;
            box.className = `overlay ${cfg.class}`;
            box.style.borderColor = cfg.color;
            box.innerHTML = `<span class="label"><span style="color:${cfg.color}">‚Äî</span> ${cfg.name}</span>`;
            elements.container.appendChild(box);
        }

        function createMenuItem(cfg, i) {
            const item = document.createElement('label');
            item.className = 'item';
            item.innerHTML = `
                <input type="checkbox" ${cfg.active ? 'checked' : ''}>
                <span class="color-dash" style="color:${cfg.color}">‚Äî</span>
                ${cfg.name}
            `;
            item.querySelector('input').onchange = (e) => {
                cfg.active = e.target.checked;
                updateLayout();
            };
            elements.ratioList.appendChild(item);
        }

        // --- Core Logic (Split Strategy for Mobile vs Desktop) ---
        function updateLayout() {
            window.requestAnimationFrame(() => {
                // 1. Force DPR correction
                let dpr = window.devicePixelRatio || 1;
                if (Math.abs(dpr * 100 % 25) < 1) {
                    dpr = Math.round(dpr * 4) / 4; 
                }

                // 2. Get Viewport Dimensions (Logical)
                const logicalW = document.documentElement.clientWidth;
                const logicalH = document.documentElement.clientHeight;

                // 3. Smart Calculation Logic
                // Separates Mobile (needs Round) from Desktop (needs Floor + Correction)
                function getCorrectedSize(logicalVal) {
                    const rawPhys = logicalVal * dpr;

                    // Detect Mobile: Has touch capability
                    const isMobile = window.matchMedia("(pointer: coarse)").matches || navigator.maxTouchPoints > 0;
                    
                    if (isMobile) {
                        // [Mobile Logic]
                        // Mobile scaling is usually more precise (integers).
                        // Use Math.round() to recover the lost 0.99 pixels.
                        // Do NOT force even numbers (phones often have odd widths).
                        return Math.round(rawPhys);
                    } else {
                        // [Desktop Logic]
                        // Windows scaling tends to overshoot (e.g. 1080.1). Use Floor.
                        let phys = Math.floor(rawPhys);
                        
                        // Force Even Correction for Desktop:
                        // If value is large (>1000) and Odd, assume it's a +1 error and fix it.
                        if (phys > 1000 && phys % 2 !== 0) {
                            return phys - 1;
                        }
                        return phys;
                    }
                }

                // 4. Calculate Accurate Physical Pixels
                const displayW = getCorrectedSize(logicalW);
                const displayH = getCorrectedSize(logicalH);
                
                // 5. Calculate Ratio
                const currentRatio = displayW / displayH;

                // 6. Update Info Tag
                elements.infoTag.innerHTML = 
                    `Display: <strong>${displayW}x${displayH}</strong> | Ratio: <strong>${currentRatio.toFixed(2)}:1</strong>`;

                // 7. Update Overlays
                configs.forEach((cfg, i) => {
                    const el = document.getElementById(`box-${i}`);
                    if (!cfg.active) {
                        el.style.display = 'none';
                        return;
                    }
                    el.style.display = 'block';
                    
                    let w, h;
                    // Fit based on current aspect ratio
                    if (currentRatio > cfg.ratio) {
                        h = logicalH; 
                        w = logicalH * cfg.ratio;
                    } else {
                        w = logicalW; 
                        h = logicalW / cfg.ratio;
                    }
                    
                    el.style.width = `${w}px`;
                    el.style.height = `${h}px`;
                });
            });
        }

        // --- UI Handlers ---
        function togglePanel() {
            const isActive = elements.panel.classList.toggle('active');
            elements.mask.style.display = isActive ? 'block' : 'none';
            elements.trigger.innerText = isActive ? '‚úï' : '‚öôÔ∏è';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    elements.container.style.backgroundImage = `url('${event.target.result}')`;
                };
                reader.readAsDataURL(file);
            }
        }

        function setupEventListeners() {
            window.addEventListener('resize', updateLayout);
            matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`).addEventListener("change", updateLayout);
            
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', updateLayout);
                window.visualViewport.addEventListener('scroll', updateLayout);
            }
            elements.fileInput.addEventListener('change', handleFileUpload);
            window.addEventListener('load', updateLayout);
        }

        // Start Tool
        init();
    </script>
    
</body>
</html>